function trajectory_to_c(vt, dt_clk, output_file, trajectory_name)
%TRAJECTORY_TO_C Export trajectory data to C header file
%
%   trajectory_to_c(vt, dt_clk, output_file, trajectory_name)
%
%   Inputs:
%       vt          - Velocity array (int16 values)
%       dt_clk      - Time delta array (uint32 clock counts)
%       output_file - Output file path (e.g., 'trajectory.h')
%       trajectory_name - Name for comments (e.g., 'figure8')
%
%   The output file contains:
%       const int16_t vt[]     - Velocity samples (9999 = end marker)
%       const uint32_t tt_clk[] - Time deltas in clock counts
%
%   Format compatible with STM32 output compare timing.

    if nargin < 4
        trajectory_name = 'trajectory';
    end
    if nargin < 3
        output_file = 'trajectory.h';
    end
    
    % Ensure column vectors
    vt = vt(:)';
    dt_clk = dt_clk(:)';
    
    % Validate inputs
    if length(dt_clk) ~= length(vt) - 1 && length(dt_clk) ~= length(vt)
        if length(dt_clk) == length(vt) - 1
            % OK - one less dt than vt points
        else
            warning('dt_clk length (%d) should be vt length (%d) or vt length - 1', ...
                    length(dt_clk), length(vt));
            % Adjust lengths
            if length(dt_clk) > length(vt)
                dt_clk = dt_clk(1:length(vt));
            else
                vt = vt(1:length(dt_clk)+1);
            end
        end
    end
    
    % Round and convert to integers
    vt_int = int16(round(vt));
    dt_uint = uint32(round(dt_clk));
    
    % Check ranges
    if any(vt_int < -32768 | vt_int > 32767)
        warning('Some vt values exceed int16 range and will be clipped');
        vt_int = max(min(vt_int, 32767), -32768);
    end
    
    % Open file for writing
    fid = fopen(output_file, 'w');
    if fid < 0
        error('Could not open file: %s', output_file);
    end
    
    % Ensure file is closed on exit
    cleanup = onCleanup(@() fclose(fid));
    
    % Write header
    fprintf(fid, '/**\n');
    fprintf(fid, ' * @file trajectory.h\n');
    fprintf(fid, ' * @brief Auto-generated trajectory data: %s\n', trajectory_name);
    fprintf(fid, ' * @date %s\n', datestr(now, 'yyyy-mm-dd HH:MM:SS'));
    fprintf(fid, ' *\n');
    fprintf(fid, ' * Generated by MATLAB trajectory_to_c.m\n');
    fprintf(fid, ' *\n');
    fprintf(fid, ' * vt[]: Velocity values (scaled encoder counts/sample)\n');
    fprintf(fid, ' *       Special value 9999 indicates end of trajectory\n');
    fprintf(fid, ' * tt_clk[]: Time deltas between points (clock counts at 170MHz)\n');
    fprintf(fid, ' *\n');
    fprintf(fid, ' * N_vt = %d, N_tt_clk = %d\n', length(vt_int), length(dt_uint));
    fprintf(fid, ' */\n\n');
    
    fprintf(fid, '#ifndef INC_TRAJECTORY_H_\n');
    fprintf(fid, '#define INC_TRAJECTORY_H_\n\n');
    
    fprintf(fid, '#include <stdint.h>\n\n');
    
    % Write vt array
    fprintf(fid, 'const uint32_t vt_len = %u;\n', uint32(length(vt_int)));
    fprintf(fid, 'const int16_t vt[%u] = {\n', uint32(length(vt_int)));
    write_array(fid, vt_int, '%d', 12);
    fprintf(fid, '};\n\n');
    
    % Write tt_clk array
    fprintf(fid, 'const uint32_t tt_clk_len = %u;\n', uint32(length(dt_uint)));
    fprintf(fid, 'const uint32_t tt_clk[%u] = {\n', uint32(length(dt_uint)));
    write_array(fid, dt_uint, '%u', 8);
    fprintf(fid, '};\n\n');
    
    fprintf(fid, '#endif /* INC_TRAJECTORY_H_ */\n');
    
    fprintf('Trajectory exported:\n');
    fprintf('  File: %s\n', output_file);
    fprintf('  Points: %d velocity, %d timing\n', length(vt_int), length(dt_uint));
    fprintf('  Total duration: %.2f s\n', sum(double(dt_uint)) / 170e6);
end

function write_array(fid, vec, fmt, per_line)
%WRITE_ARRAY Helper to write array in C initializer format
    n = length(vec);
    for i = 1:n
        if mod(i-1, per_line) == 0
            fprintf(fid, '    ');
        end
        
        if i < n
            fprintf(fid, [fmt, ', '], vec(i));
        else
            fprintf(fid, fmt, vec(i));
        end
        
        if mod(i, per_line) == 0 && i < n
            fprintf(fid, '\n');
        end
    end
    fprintf(fid, '\n');
end

