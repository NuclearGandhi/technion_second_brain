function trajectory_to_c(vx, vy, wz, dt_clk, output_file, trajectory_name)
    %TRAJECTORY_TO_C Export trajectory data to C header file
    %
    %   trajectory_to_c(vx, vy, wz, dt_clk, output_file, trajectory_name)
    %
    %   Inputs:
    %       vx          - X velocity array [m/s]
    %       vy          - Y velocity array [m/s]
    %       wz          - Angular velocity array [rad/s]
    %       dt_clk      - Time delta array (uint32 clock counts)
    %       output_file - Output file path (e.g., 'trajectory.h')
    %       trajectory_name - Name for comments (e.g., 'figure8')
    %
    %   The output file contains:
    %       const float vx_t[]     - X velocity samples [m/s]
    %       const float vy_t[]     - Y velocity samples [m/s]
    %       const float wz_t[]     - Angular velocity samples [rad/s]
    %       const uint32_t tt_clk[] - Time deltas in clock counts
    %
    %   Format compatible with STM32 output compare timing.

    if nargin < 6
        trajectory_name = 'trajectory';
    end

    if nargin < 5
        output_file = 'trajectory.h';
    end

    % Ensure row vectors
    vx = vx(:)';
    vy = vy(:)';
    wz = wz(:)';
    dt_clk = dt_clk(:)';

    n_vel = length(vx);
    n_dt = length(dt_clk);

    % Validate inputs
    if length(vy) ~= n_vel || length(wz) ~= n_vel
        error('vx, vy, wz must have the same length');
    end

    if n_dt ~= n_vel - 1 && n_dt ~= n_vel
        warning('dt_clk length (%d) should be vx length (%d) or vx length - 1', n_dt, n_vel);
    end

    % Round dt to integers
    dt_uint = uint32(round(dt_clk));

    % Scale velocities (keep as float, but scale to reasonable range)
    % vx, vy are in m/s, wz is in rad/s - these are already good units
    vx_scaled = vx;
    vy_scaled = vy;
    wz_scaled = wz;

    % Open file for writing
    fid = fopen(output_file, 'w');

    if fid < 0
        error('Could not open file: %s', output_file);
    end

    % Ensure file is closed on exit
    cleanup = onCleanup(@() fclose(fid));

    % Write header
    fprintf(fid, '/**\n');
    fprintf(fid, ' * @file trajectory.h\n');
    fprintf(fid, ' * @brief Auto-generated trajectory data: %s\n', trajectory_name);
    fprintf(fid, ' * @date %s\n', datestr(now, 'yyyy-mm-dd HH:MM:SS'));
    fprintf(fid, ' *\n');
    fprintf(fid, ' * Generated by MATLAB trajectory_to_c.m\n');
    fprintf(fid, ' *\n');
    fprintf(fid, ' * vx_t[], vy_t[], wz_t[] : Cart velocities [m/s, m/s, rad/s]\n');
    fprintf(fid, ' * tt_clk[]: Time deltas between points (clock counts at 17MHz after prescaler)\n');
    fprintf(fid, ' *\n');
    fprintf(fid, ' * N_points = %d, N_tt_clk = %d\n', n_vel, n_dt);
    fprintf(fid, ' */\n\n');

    fprintf(fid, '#ifndef INC_TRAJECTORY_H_\n');
    fprintf(fid, '#define INC_TRAJECTORY_H_\n\n');

    fprintf(fid, '#include <stdint.h>\n\n');

    % Write trajectory length
    fprintf(fid, 'const uint32_t traj_len = %u;\n\n', uint32(n_vel));

    % Write vx array
    fprintf(fid, 'const float vx_t[%u] = {\n', uint32(n_vel));
    write_float_array(fid, vx_scaled, 8);
    fprintf(fid, '};\n\n');

    % Write vy array
    fprintf(fid, 'const float vy_t[%u] = {\n', uint32(n_vel));
    write_float_array(fid, vy_scaled, 8);
    fprintf(fid, '};\n\n');

    % Write wz array
    fprintf(fid, 'const float wz_t[%u] = {\n', uint32(n_vel));
    write_float_array(fid, wz_scaled, 8);
    fprintf(fid, '};\n\n');

    % Write tt_clk array
    fprintf(fid, 'const uint32_t tt_clk_len = %u;\n', uint32(n_dt));
    fprintf(fid, 'const uint32_t tt_clk[%u] = {\n', uint32(n_dt));
    write_uint_array(fid, dt_uint, 8);
    fprintf(fid, '};\n\n');

    fprintf(fid, '#endif /* INC_TRAJECTORY_H_ */\n');

    fprintf('Trajectory exported:\n');
    fprintf('  File: %s\n', output_file);
    fprintf('  Points: %d\n', n_vel);
    fprintf('  Total duration: %.2f s\n', sum(double(dt_uint)) / 17e6); % 17MHz after prescaler
    fprintf('  vx range: [%.3f, %.3f] m/s\n', min(vx_scaled), max(vx_scaled));
    fprintf('  vy range: [%.3f, %.3f] m/s\n', min(vy_scaled), max(vy_scaled));
    fprintf('  wz range: [%.3f, %.3f] rad/s\n', min(wz_scaled), max(wz_scaled));
end

function write_float_array(fid, vec, per_line)
    %WRITE_FLOAT_ARRAY Helper to write float array in C initializer format
    n = length(vec);

    for i = 1:n

        if mod(i - 1, per_line) == 0
            fprintf(fid, '    ');
        end

        if i < n
            fprintf(fid, '%.6ff, ', vec(i));
        else
            fprintf(fid, '%.6ff', vec(i));
        end

        if mod(i, per_line) == 0 && i < n
            fprintf(fid, '\n');
        end

    end

    fprintf(fid, '\n');
end

function write_uint_array(fid, vec, per_line)
    %WRITE_UINT_ARRAY Helper to write uint32 array in C initializer format
    n = length(vec);

    for i = 1:n

        if mod(i - 1, per_line) == 0
            fprintf(fid, '    ');
        end

        if i < n
            fprintf(fid, '%u, ', vec(i));
        else
            fprintf(fid, '%u', vec(i));
        end

        if mod(i, per_line) == 0 && i < n
            fprintf(fid, '\n');
        end

    end

    fprintf(fid, '\n');
end
